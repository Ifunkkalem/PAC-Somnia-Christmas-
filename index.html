<!--
  PAC-MAN WEB3: Sinterklas VS Grinch
  Tata Letak Baru: Dua Bilah Responsif (Sidebar & Konten Utama)
  Mengintegrasikan Web3, Game Engine, dan Firebase Leaderboard.
-->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinterklas VS Grinch ðŸŽ„</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase (for Leaderboard storage) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, limit, onSnapshot, orderBy, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel global Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pacman-christmas-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            setLogLevel('debug'); // Aktifkan log Firebase
            const parsedConfig = JSON.parse(firebaseConfig);
            const app = initializeApp(parsedConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Fungsi untuk login
            const signIn = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Kesalahan saat otentikasi Firebase:", error);
                }
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // Jika pengguna log-out, coba masuk anonim
                    signInAnonymously(auth).then(anonUser => {
                        userId = anonUser.user.uid;
                    }).catch(err => {
                        console.error("Gagal masuk anonim:", err);
                        userId = 'guest-' + crypto.randomUUID(); // Fallback ID
                    });
                }
                isAuthReady = true;
                // Panggil fungsi yang bergantung pada Auth setelah otentikasi
                if (window.initApp) {
                    window.initApp(db, userId);
                }
            });

            signIn();
        }

        window.firebaseData = {
            getDb: () => db,
            getUserId: () => userId,
            isAuthReady: () => isAuthReady,
            getAppId: () => appId,
        };
    </script>
    <!-- Ethers.js for Web3 interaction -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b1a2a; /* Dark Blue Christmas Theme */
            color: #ffffff;
            min-height: 100vh;
        }
        
        /* Tata Letak Utama - Flex/Grid Responsif */
        #main-layout {
            display: flex;
            flex-direction: column; /* Mobile: Stacks vertically */
            max-width: 1200px;
            width: 95%;
            margin: 20px auto;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7);
            background-color: #1a2c42;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            #main-layout {
                flex-direction: row; /* Desktop: Two columns */
                min-height: 700px;
            }
        }

        /* Panel Kiri (Sidebar) */
        #left-panel {
            background-color: #112033; /* Warna Sidebar Lebih Gelap */
            padding: 20px;
            flex-shrink: 0;
            width: 100%;
            border-bottom: 2px solid #cc0000;
        }
        @media (min-width: 768px) {
            #left-panel {
                width: 350px; /* Lebar tetap untuk desktop */
                border-right: 2px solid #cc0000;
                border-bottom: none;
                overflow-y: auto; /* Agar bisa di-scroll jika tinggi */
            }
        }
        
        /* Panel Kanan (Konten Utama) */
        #right-panel {
            flex-grow: 1;
            padding: 20px;
            background-color: #1a2c42;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        canvas {
            background-color: #2c4766;
            display: block;
            border: 4px solid #cc0000; /* Red border */
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            width: 100%;
            height: auto;
            max-width: 400px; /* Ukuran maksimal kanvas */
        }
        .btn-primary {
            background-color: #16a34a;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            transition: background-color 0.2s;
            cursor: pointer;
            box-shadow: 0 4px #0f763e;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .btn-primary:hover {
            background-color: #15803d;
        }
        .btn-primary:active {
            box-shadow: none;
            transform: translateY(4px);
        }
        .btn-secondary {
            background-color: #cc0000;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            transition: background-color 0.2s;
            cursor: pointer;
            box-shadow: 0 4px #990000;
        }
        .btn-secondary:hover {
            background-color: #990000;
        }
        .btn-secondary:active {
            box-shadow: none;
            transform: translateY(4px);
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: #2c4766;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .control-btn {
            background-color: #3b82f6;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            transition: background-color 0.1s, transform 0.1s;
            box-shadow: 0 3px #2563eb;
            cursor: pointer;
        }
        .control-btn:active {
            box-shadow: none;
            transform: translateY(3px);
            background-color: #1d4ed8;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1a2c42;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            max-width: 90%;
            border: 3px solid #cc0000;
        }
    </style>
</head>
<body>

    <div id="main-layout">
        
        <!-- ========================================================= -->
        <!-- BILAH KIRI: KONTROL, WALLET, DAN NAVIGATION -->
        <!-- ========================================================= -->
        <div id="left-panel">
            <h1 class="text-3xl font-black text-center mb-6 text-[#16a34a] border-b pb-4 border-[#cc0000]">
                SINTERKLAS VS GRINCH 
                <span class="text-xl block text-white font-bold">Pac-Man Web3</span>
            </h1>
            
            <div class="space-y-4 mb-8">
                
                <!-- Info Status Koneksi -->
                <div id="connection-status-info" class="p-3 rounded-xl bg-[#2c4766] border border-[#16a34a]">
                    <p class="font-bold text-lg mb-2 text-[#facc15]">Status Dompet:</p>
                    <button id="connect-wallet-btn" class="w-full btn-primary">
                        <span id="wallet-status">Hubungkan Dompet</span>
                    </button>
                    
                    <!-- Detail Dompet (Hanya muncul jika terkoneksi) -->
                    <div id="wallet-details" class="hidden text-sm mt-3 space-y-1">
                        <div class="truncate">Alamat: <span id="connected-address" class="text-yellow-300 font-medium"></span></div>
                        <div id="user-balance">Saldo: Memuat...</div>
                        <div class="text-xs italic text-gray-400">Jaringan: Somnia Mainnet (5031)</div>
                    </div>
                </div>

                <!-- Input & Tombol Mulai Game -->
                <div id="game-controls" class="space-y-3 p-3 rounded-xl bg-[#cc0000] shadow-lg">
                     <p class="font-bold text-lg text-white">Siap Bermain?</p>
                     
                     <input type="text" id="display-name-input" placeholder="Nama Tampilan (Max 20 Karakter)" maxlength="20" class="w-full p-3 rounded-xl bg-[#1a2c42] text-white border border-white focus:ring focus:ring-[#facc15] focus:border-[#facc15]">
                     
                     <button id="start-game-btn" class="w-full btn-primary disabled:bg-gray-500 disabled:shadow-none">
                         MULAI BERMAIN
                     </button>
                     <div class="text-xs text-center text-gray-200">
                         Biaya Mulai: <span id="start-fee-display">0.0</span> SOMI
                     </div>
                </div>
            </div>
            
            <!-- Navigasi View -->
            <div class="border-t pt-4 border-gray-600">
                <p class="font-bold text-lg mb-3">Tampilan Konten:</p>
                <div class="flex space-x-3">
                    <button id="nav-leaderboard" class="flex-1 btn-secondary" onclick="switchView('leaderboard')">
                        Papan Peringkat
                    </button>
                    <button id="nav-game" class="flex-1 btn-primary disabled:bg-gray-500" onclick="switchView('game')" disabled>
                        Tampilan Game
                    </button>
                </div>
                <div class="text-xs text-gray-400 mt-2 italic">
                     UID Anda: <span id="user-firebase-id">Memuat...</span>
                </div>
            </div>
        </div>
        
        <!-- ========================================================= -->
        <!-- BILAH KANAN: KONTEN UTAMA (Leaderboard / Game) -->
        <!-- ========================================================= -->
        <div id="right-panel">
            <div id="content-panel" class="w-full h-full flex flex-col items-center">
            
                <!-- 1. Tampilan Papan Peringkat (Default) -->
                <div id="leaderboard-view" class="w-full max-w-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 text-[#facc15]">PAPAN PERINGKAT GLOBAL</h2>
                    <div id="leaderboard-list" class="space-y-2">
                        <!-- Data peringkat akan dimuat di sini -->
                        <div class="text-center text-gray-300 p-4">Memuat peringkat...</div>
                    </div>
                </div>
                
                <!-- 2. Tampilan Game (Tersembunyi Awalnya) -->
                <div id="game-view" class="w-full max-w-lg hidden flex flex-col items-center">
                    <h2 class="text-2xl font-bold mb-4 text-[#facc15]">AREA BERMAIN</h2>
                    
                    <div class="flex justify-between items-center w-full max-w-xs mb-4">
                        <div class="text-xl font-bold">Skor: <span id="current-score-display">0</span></div>
                        <div id="game-message" class="text-lg font-extrabold text-red-500" style="display:none;"></div>
                    </div>
                    
                    <canvas id="pacman-canvas"></canvas>
                    
                    <!-- Kontrol Tombol Mobile/Sentuh -->
                    <div class="flex flex-col items-center mt-6">
                        <p class="text-sm font-bold mb-2">Kontrol Sentuh</p>
                        <div class="grid grid-cols-3 gap-3 w-48">
                            <div></div>
                            <button class="control-btn" data-key="w">â–²</button>
                            <div></div>
                            <button class="control-btn" data-key="a">â—€</button>
                            <button class="control-btn" data-key="s">â–¼</button>
                            <button class="control-btn" data-key="d">â–¶</button>
                        </div>
                        <p class="text-sm text-gray-400 mt-4">Gunakan WASD/panah di keyboard untuk desktop.</p>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>

    <!-- Modal Pesan Kustom -->
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-[#facc15]">Pesan</h3>
            <p id="modal-message" class="mb-6 text-gray-200"></p>
            <div class="flex flex-col space-y-3">
                <button id="modal-network-btn" class="btn-secondary hidden">Pindah ke Somnia Mainnet (5031)</button>
                <button id="modal-close-btn" class="btn-primary">Tutup</button>
            </div>
        </div>
    </div>

<script>
    // ====================================================================
    // 1. KONFIGURASI WEB3 & FIREBASE
    // ====================================================================

    // Alamat Kontrak pintar PacmanLeaderboard di Somnia Mainnet (EIP-55 Checksum)
    const CONTRACT_ADDRESS = "0xD76b767102F2610b0c97Fee84873C1fAA4C7c365";
    // Chain ID yang BENAR: 5031
    const REQUIRED_CHAIN_ID = 5031; 
    const REQUIRED_NETWORK_NAME = "Somnia Mainnet";
    const REQUIRED_NETWORK_PARAMS = [{
        chainId: '0x13a7', // 5031 dalam Hex
        chainName: REQUIRED_NETWORK_NAME,
        nativeCurrency: {
            name: 'SOMI',
            symbol: 'SOMI',
            decimals: 18
        },
        rpcUrls: ['https://somnia-rpc.publicnode.com'], 
        blockExplorerUrls: ['https://explorer.somnia.network']
    }];
    
    // ABI (Application Binary Interface) yang disederhanakan
    const CONTRACT_ABI = [
        "function startGame(string memory _username) public payable returns (uint256)",
        "function submitScore(uint256 _score, uint256 _gameId, string memory _username) public",
        "function startFeeWei() view returns (uint256)",
        "event GameStarted(address indexed player, uint256 gameId, uint256 timestamp)",
        "event ScoreSubmitted(address indexed player, uint256 score, uint256 totalScore, uint256 timestamp)",
    ];

    // Status Web3
    let provider = null;
    let signer = null;
    let contract = null;
    let userAddress = null;
    let userBalance = "0";
    let gameId = 0; // ID unik untuk setiap sesi game
    let startFeeWei = ethers.BigNumber.from(0);

    // Status Firebase
    let db = null;
    let firebaseUserId = null;
    let appId = null;
    const LEADERBOARD_COLLECTION = "leaderboard";

    // ====================================================================
    // 2. UTILITAS & UI MANAGEMENT
    // ====================================================================
    
    let currentView = 'leaderboard'; // 'leaderboard' atau 'game'

    /** Mengganti tampilan konten utama */
    function switchView(viewName) {
        if (viewName === 'game' && !gameRunning) {
             showModal("Peringatan", "Anda harus menekan 'MULAI BERMAIN' untuk mengaktifkan tampilan Game.");
             return;
        }

        currentView = viewName;
        document.getElementById('leaderboard-view').classList.toggle('hidden', viewName !== 'leaderboard');
        document.getElementById('game-view').classList.toggle('hidden', viewName !== 'game');
        
        document.getElementById('nav-leaderboard').disabled = (viewName === 'leaderboard');
        document.getElementById('nav-game').disabled = (viewName === 'game');
    }

    /** Menampilkan modal pesan kustom */
    function showModal(title, message, isNetworkError = false) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').innerHTML = message;
        document.getElementById('modal-network-btn').classList.toggle('hidden', !isNetworkError);
        document.getElementById('custom-modal').classList.remove('hidden');
        
        document.getElementById('modal-close-btn').onclick = () => {
            document.getElementById('custom-modal').classList.add('hidden');
        };
        
        if (isNetworkError) {
             document.getElementById('modal-network-btn').onclick = addSomniaNetwork;
        }
    }
    
    /** Mencoba menambahkan atau beralih ke Somnia Mainnet melalui dompet */
    async function addSomniaNetwork() {
        if (!window.ethereum) {
            showModal("Kesalahan", "Anda perlu dompet Web3 (seperti MetaMask) untuk menggunakan fitur ini.");
            return;
        }
        
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0x13a7' }],
            });
            window.location.reload();
        } catch (switchError) {
            if (switchError.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: REQUIRED_NETWORK_PARAMS,
                    });
                    window.location.reload();
                } catch (addError) {
                    showModal("Gagal Menambahkan Jaringan", `Gagal menambahkan ${REQUIRED_NETWORK_NAME}. Pesan: ${addError.message || addError.code}`);
                }
            } else {
                showModal("Gagal Beralih Jaringan", `Terjadi kesalahan saat beralih jaringan. Pesan: ${switchError.message || switchError.code}`);
            }
        }
    }


    /** Memperbarui tampilan UI dompet */
    function updateWalletUI() {
        const connectBtn = document.getElementById('connect-wallet-btn');
        const walletDetails = document.getElementById('wallet-details');
        const addressElement = document.getElementById('connected-address');
        const balanceElement = document.getElementById('user-balance');
        const startFeeDisplay = document.getElementById('start-fee-display');
        const startGameBtn = document.getElementById('start-game-btn');
        const navGameBtn = document.getElementById('nav-game');

        startFeeDisplay.textContent = ethers.utils.formatEther(startFeeWei);

        if (userAddress) {
            // Tampilkan detail dompet, sembunyikan tombol koneksi
            connectBtn.classList.add('hidden');
            walletDetails.classList.remove('hidden');
            
            addressElement.textContent = userAddress.substring(0, 6) + "..." + userAddress.substring(userAddress.length - 4);
            balanceElement.textContent = `Saldo: ${userBalance} SOMI`;
            startGameBtn.disabled = false;
            navGameBtn.disabled = false;
        } else {
            // Tampilkan tombol koneksi, sembunyikan detail dompet
            connectBtn.classList.remove('hidden');
            document.getElementById('wallet-status').textContent = "Hubungkan Dompet";
            walletDetails.classList.add('hidden');
            startGameBtn.disabled = true;
            navGameBtn.disabled = true;
        }
    }

    // ====================================================================
    // 3. FUNGSI WEB3
    // ====================================================================

    /** Menginisialisasi koneksi Web3 (MetaMask/Provider) */
    async function initWeb3() {
        if (!window.ethereum) {
            document.getElementById('wallet-status').textContent = "Instal MetaMask!";
            showModal("Kesalahan", "Silakan instal MetaMask atau dompet Web3 yang kompatibel.");
            return;
        }
        
        try {
            document.getElementById('wallet-status').textContent = "Menghubungkan...";
            
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            
            // Periksa jaringan (Chain ID Wajib)
            const { chainId } = await provider.getNetwork();
            if (chainId !== REQUIRED_CHAIN_ID) {
                showModal("Kesalahan Jaringan", 
                    `Silakan pindah ke jaringan **${REQUIRED_NETWORK_NAME}** (Chain ID: ${REQUIRED_CHAIN_ID}).`,
                    true // isNetworkError = true
                );
                userAddress = null;
                updateWalletUI(); 
                return;
            }

            // Inisialisasi Kontrak
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            
            // Ambil saldo dan biaya
            const [balanceWei, feeWei] = await Promise.all([
                provider.getBalance(userAddress),
                contract.startFeeWei()
            ]);
            
            userBalance = ethers.utils.formatEther(balanceWei);
            startFeeWei = feeWei;

            updateWalletUI();

            // Dengarkan perubahan akun/jaringan
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());

        } catch (error) {
            console.error("Kesalahan saat koneksi dompet:", error);
            userAddress = null;
            updateWalletUI();
            
            let errorMessage = error.message || error.code;
            if (error.code === 4001) {
                errorMessage = "Anda menolak permintaan koneksi dompet.";
            }

            showModal("Koneksi Gagal", `Terjadi kesalahan saat menghubungkan dompet: ${errorMessage}.`);
        }
    }

    /** Memulai sesi game melalui kontrak pintar */
    async function startGameTx() {
        if (!contract || !userAddress) {
            showModal("Peringatan", "Dompet belum terhubung.");
            return;
        }

        const username = document.getElementById('display-name-input').value.trim() || 'AnonPlayer';
        if (username.length > 20) {
            showModal("Peringatan", "Nama tampilan maksimal 20 karakter.");
            return;
        }
        
        // Cek saldo
        if (ethers.utils.parseEther(userBalance).lt(startFeeWei)) {
            showModal("Saldo Kurang", `Anda membutuhkan ${ethers.utils.formatEther(startFeeWei)} SOMI untuk memulai game.`);
            return;
        }

        try {
            const startBtn = document.getElementById('start-game-btn');
            startBtn.textContent = "Menunggu Konfirmasi...";
            startBtn.disabled = true;

            const tx = await contract.startGame(username, {
                value: startFeeWei 
            });

            showModal("Transaksi Terkirim", `Transaksi memulai game telah dikirim. Harap tunggu konfirmasi.`);
            
            const receipt = await tx.wait();
            console.log("Transaksi startGame berhasil:", receipt);

            const gameStartedEvent = receipt.events.find(e => e.event === 'GameStarted');
            if (gameStartedEvent) {
                gameId = gameStartedEvent.args.gameId.toNumber();
                
                showModal("Game Siap!", "Transaksi berhasil dikonfirmasi. Anda bisa mulai bermain sekarang!");
                
                startBtn.textContent = "ULANGI SESI";
                startBtn.disabled = false;
                
                // Aktifkan dan pindah ke tampilan game
                switchView('game');

                // Reset dan mulai permainan Pac-Man
                resetGame();
                startGameLoop();

            } else {
                throw new Error("Event GameStarted tidak ditemukan.");
            }

        } catch (error) {
            console.error("Transaksi startGame Gagal:", error);
            const startBtn = document.getElementById('start-game-btn');
            startBtn.textContent = "MULAI BERMAIN";
            startBtn.disabled = false;
            
            let errorMessage = error.code === 4001 ? "Anda membatalkan transaksi." : (error.data?.message || "Gagal memulai game.");
            showModal("Transaksi Gagal", `Pesan Kesalahan: ${errorMessage}`);
        }
    }

    /** Mengirim skor akhir ke kontrak pintar */
    async function submitScoreTx(finalScore) {
        if (!contract || !gameId) {
            console.error("Tidak ada kontrak atau Game ID.");
            return;
        }

        const username = document.getElementById('display-name-input').value.trim() || 'AnonPlayer';

        try {
            showModal("Mengirim Skor", `Skor ${finalScore} Anda sedang dikirim ke blockchain. Harap tunggu.`);
            
            const tx = await contract.submitScore(finalScore, gameId, username);
            
            const receipt = await tx.wait();
            console.log("Transaksi submitScore berhasil:", receipt);

            const scoreSubmittedEvent = receipt.events.find(e => e.event === 'ScoreSubmitted');
            let newTotalScore = finalScore;
            if (scoreSubmittedEvent) {
                newTotalScore = scoreSubmittedEvent.args.totalScore.toNumber();
            }

            await saveScoreToFirestore(newTotalScore, username);
            
            showModal("Skor Berhasil Dikirim!", `Skor akhir (${finalScore}) berhasil dicatat! Total Skor Akumulasi Anda: ${newTotalScore.toLocaleString()}.`);

        } catch (error) {
            console.error("Transaksi submitScore Gagal:", error);
            
            let errorMessage = error.code === 4001 ? "Anda membatalkan pengiriman skor." : (error.data?.message || "Gagal mengirim skor.");
            showModal("Pengiriman Skor Gagal", `Pesan Kesalahan: ${errorMessage}`);
        }
    }


    // ====================================================================
    // 4. FUNGSI FIREBASE (Leaderboard)
    // ====================================================================

    /** Fungsi untuk inisialisasi Firebase dari luar (dipanggil setelah auth siap) */
    window.initApp = (firestoreInstance, currentUserId) => {
        db = firestoreInstance;
        firebaseUserId = currentUserId;
        appId = window.firebaseData.getAppId();
        document.getElementById('user-firebase-id').textContent = firebaseUserId;
        loadLeaderboard();
    };

    /** Memuat 10 Peringkat Teratas */
    function loadLeaderboard() {
        if (!db || !appId) return;
        
        const q = query(
            collection(db, "artifacts", appId, "public", "data", LEADERBOARD_COLLECTION),
            orderBy("totalScore", "desc"),
            limit(10)
        );

        onSnapshot(q, (snapshot) => {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            
            if (snapshot.empty) {
                leaderboardList.innerHTML = '<div class="text-center text-gray-300 p-4">Belum ada skor.</div>';
                return;
            }

            snapshot.forEach((doc, index) => {
                const data = doc.data();
                const scoreItem = document.createElement('div');
                const isCurrentUser = data.userId === firebaseUserId;
                scoreItem.className = 'leaderboard-item ' + (isCurrentUser ? 'bg-red-700 hover:bg-red-800' : 'bg-[#2c4766] hover:bg-[#3d5a7d]');
                scoreItem.innerHTML = `
                    <span class="font-bold text-xl text-[#facc15]">${index + 1}.</span>
                    <span class="flex-grow mx-4 text-left">${data.username || 'Pemain Anon'} <span class="text-xs text-gray-400">(${data.userId.substring(0, 4)}...)</span></span>
                    <span class="font-bold text-lg text-white">${data.totalScore.toLocaleString()}</span>
                `;
                leaderboardList.appendChild(scoreItem);
            });
        }, (error) => {
             console.error("Gagal memuat leaderboard dari Firestore:", error);
             document.getElementById('leaderboard-list').innerHTML = '<div class="text-center text-red-400 p-4">Gagal memuat Leaderboard.</div>';
        });
    }

    /** Menyimpan skor akumulasi total ke Firestore (dipanggil SETELAH sukses di blockchain) */
    async function saveScoreToFirestore(newTotalScore, username) {
        if (!db || !appId || !firebaseUserId) {
            console.error("Firestore belum siap untuk menyimpan skor.");
            return;
        }

        try {
            const docRef = doc(db, "artifacts", appId, "public", "data", LEADERBOARD_COLLECTION, firebaseUserId);

            await setDoc(docRef, {
                userId: firebaseUserId,
                username: username,
                totalScore: newTotalScore,
                lastUpdated: new Date().toISOString()
            }, { merge: true }); 

        } catch (error) {
            console.error("Gagal menyimpan skor ke Firestore:", error);
        }
    }

    // ====================================================================
    // 5. LOGIKA GAME (PAC-MAN)
    // ====================================================================

    const canvas = document.getElementById('pacman-canvas');
    const ctx = canvas.getContext('2d');
    const TILE_SIZE = 20;
    // Map yang sama
    const GAME_MAP = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
        [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
        [1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
        [0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
        [1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
        [1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
        [1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];
    const MAP_WIDTH = GAME_MAP[0].length;
    const MAP_HEIGHT = GAME_MAP.length;
    
    // Set ukuran Kanvas
    canvas.width = MAP_WIDTH * TILE_SIZE;
    canvas.height = MAP_HEIGHT * TILE_SIZE;

    // Game state
    let pacman = { x: 1, y: 1, dir: 'right', nextDir: 'right', radius: TILE_SIZE / 2.5 };
    let ghosts = [
        { x: 9, y: 9, color: '#cc0000', dir: 'up', speed: 1 }, 
        { x: 10, y: 9, color: '#16a34a', dir: 'down', speed: 1 }, 
    ];
    let score = 0;
    let gameRunning = false;
    let mapData = [];
    let animationFrameId = null;

    function resetMapData() {
        mapData = GAME_MAP.map(row => [...row]);
        score = 0;
        pacman = { x: 1, y: 1, dir: 'right', nextDir: 'right', radius: TILE_SIZE / 2.5 };
        ghosts = [
            { x: 9, y: 9, color: '#cc0000', dir: 'up', speed: 1 }, 
            { x: 10, y: 9, color: '#16a34a', dir: 'down', speed: 1 }, 
        ];
    }

    function resetGame() {
        resetMapData();
        document.getElementById('current-score-display').textContent = score;
        document.getElementById('game-message').style.display = 'none';
        gameRunning = true;
    }

    function drawMap() {
        for (let y = 0; y < MAP_HEIGHT; y++) {
            for (let x = 0; x < MAP_WIDTH; x++) {
                const type = mapData[y][x];
                
                if (type === 1) { // Tembok (Wall)
                    ctx.fillStyle = '#cc0000'; // Merah
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    ctx.strokeStyle = '#ffffff'; // Putih
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE);
                    ctx.lineTo(x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + TILE_SIZE);
                    ctx.stroke();
                } else {
                    ctx.fillStyle = '#1a2c42'; // Jalur
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);

                    if (type === 2) { // Pellet
                        ctx.fillStyle = '#facc15'; // Emas
                        ctx.beginPath();
                        ctx.arc(x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + TILE_SIZE / 2, TILE_SIZE / 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
        }
    }

    function drawPacman() {
        const x = pacman.x * TILE_SIZE + TILE_SIZE / 2;
        const y = pacman.y * TILE_SIZE + TILE_SIZE / 2;
        ctx.fillStyle = '#facc15'; // Kuning
        ctx.beginPath();
        
        const mouthOpen = Math.abs(Math.sin(Date.now() / 100));
        const angleOffset = { 'right': 0, 'left': Math.PI, 'up': -Math.PI / 2, 'down': Math.PI / 2 }[pacman.dir];
        const startAngle = angleOffset + mouthOpen * 0.4;
        const endAngle = angleOffset - mouthOpen * 0.4 + 2 * Math.PI;

        ctx.arc(x, y, pacman.radius, startAngle, endAngle, false);
        ctx.lineTo(x, y);
        ctx.closePath();
        ctx.fill();
    }

    function drawGhosts() {
        ghosts.forEach(ghost => {
            const x = ghost.x * TILE_SIZE + TILE_SIZE / 2;
            const y = ghost.y * TILE_SIZE + TILE_SIZE / 2;
            
            ctx.fillStyle = ghost.color;
            ctx.beginPath();
            // Badan
            ctx.arc(x, y, TILE_SIZE / 2, Math.PI, 0, false);
            ctx.rect(x - TILE_SIZE / 2, y, TILE_SIZE, TILE_SIZE / 2);
            // Kaki (Skirt)
            const wobble = Math.sin(Date.now() / 200) * 2;
            ctx.moveTo(x - TILE_SIZE / 2, y + TILE_SIZE / 2);
            ctx.lineTo(x - TILE_SIZE / 2 + TILE_SIZE / 4 + wobble, y + TILE_SIZE / 2 - 3);
            ctx.lineTo(x, y + TILE_SIZE / 2);
            ctx.lineTo(x + TILE_SIZE / 2 - TILE_SIZE / 4 - wobble, y + TILE_SIZE / 2 - 3);
            ctx.lineTo(x + TILE_SIZE / 2, y + TILE_SIZE / 2);
            
            ctx.fill();
            
            // Mata
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(x - TILE_SIZE / 4, y - TILE_SIZE / 4, TILE_SIZE / 8, 0, Math.PI * 2);
            ctx.arc(x + TILE_SIZE / 4, y - TILE_SIZE / 4, TILE_SIZE / 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Pupil
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(x - TILE_SIZE / 4 + 1, y - TILE_SIZE / 4, TILE_SIZE / 16, 0, Math.PI * 2);
            ctx.arc(x + TILE_SIZE / 4 + 1, y - TILE_SIZE / 4, TILE_SIZE / 16, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function movePacman() {
        const nextX = pacman.x + (pacman.nextDir === 'right' ? 1 : pacman.nextDir === 'left' ? -1 : 0);
        const nextY = pacman.y + (pacman.nextDir === 'down' ? 1 : pacman.nextDir === 'up' ? -1 : 0);

        if (mapData[nextY] && mapData[nextY][nextX] !== 1) {
            pacman.dir = pacman.nextDir;
            pacman.x = nextX;
            pacman.y = nextY;
        } else {
            const currentX = pacman.x + (pacman.dir === 'right' ? 1 : pacman.dir === 'left' ? -1 : 0);
            const currentY = pacman.y + (pacman.dir === 'down' ? 1 : pacman.dir === 'up' ? -1 : 0);

            if (mapData[currentY] && mapData[currentY][currentX] !== 1) {
                pacman.x = currentX;
                pacman.y = currentY;
            }
        }
        
        // Teleport
        if (pacman.x < 0) pacman.x = MAP_WIDTH - 1;
        if (pacman.x >= MAP_WIDTH) pacman.x = 0;
    }

    function moveGhosts() {
        ghosts.forEach(ghost => {
            const possibleMoves = [];
            const moves = [
                { dx: 1, dy: 0, dir: 'right' },
                { dx: -1, dy: 0, dir: 'left' },
                { dx: 0, dy: 1, dir: 'down' },
                { dx: 0, dy: -1, dir: 'up' }
            ];

            moves.forEach(move => {
                const nextX = ghost.x + move.dx;
                const nextY = ghost.y + move.dy;
                
                if (mapData[nextY] && mapData[nextY][nextX] !== 1) {
                    possibleMoves.push(move);
                }
            });

            if (possibleMoves.length > 0) {
                const move = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                ghost.x += move.dx;
                ghost.y += move.dy;
                ghost.dir = move.dir;
            }
        });
    }
    
    function checkCollision() {
        // Cek dot
        if (mapData[pacman.y][pacman.x] === 2) {
            mapData[pacman.y][pacman.x] = 0; 
            score += 10;
            document.getElementById('current-score-display').textContent = score;

            let dotsRemaining = mapData.flat().filter(cell => cell === 2).length;
            if (dotsRemaining === 0) {
                endGame("SELAMAT! LEVEL SELESAI!", true);
            }
        }

        // Cek hantu
        ghosts.forEach(ghost => {
            if (pacman.x === ghost.x && pacman.y === ghost.y) {
                endGame("Misi Gagal! Anda tertangkap!", false);
            }
        });
    }

    function endGame(message, isWin) {
        if (!gameRunning) return;
        gameRunning = false;
        cancelAnimationFrame(animationFrameId);
        
        document.getElementById('game-message').textContent = message;
        document.getElementById('game-message').style.display = 'block';
        
        // Kirim skor jika skor > 0 atau jika menang
        if (score > 0 || isWin) {
            submitScoreTx(score);
        }

        // Kembali ke tampilan leaderboard setelah 5 detik
        setTimeout(() => {
            document.getElementById('game-message').style.display = 'none';
            switchView('leaderboard');
        }, 5000);
    }

    let lastTime = 0;
    const GAME_UPDATE_INTERVAL = 150; 
    let gameUpdateTimer = 0;

    function gameLoop(timestamp) {
        if (!gameRunning) return;

        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMap();
        drawPacman();
        drawGhosts();
        
        gameUpdateTimer += deltaTime;
        if (gameUpdateTimer > GAME_UPDATE_INTERVAL) {
            movePacman();
            moveGhosts(); 
            checkCollision();
            gameUpdateTimer = 0;
        }

        animationFrameId = requestAnimationFrame(gameLoop);
    }
    
    function startGameLoop() {
        gameRunning = true;
        lastTime = performance.now();
        gameLoop(lastTime);
    }

    // ====================================================================
    // 6. EVENT LISTENERS
    // ====================================================================

    // Tombol Koneksi
    document.getElementById('connect-wallet-btn').addEventListener('click', initWeb3);

    // Tombol Mulai Game
    document.getElementById('start-game-btn').addEventListener('click', startGameTx);

    // Kontrol Keyboard
    document.addEventListener('keydown', (e) => {
        if (!gameRunning) return;
        const key = e.key.toLowerCase();
        if (['w', 'a', 's', 'd', 'arrowup', 'arrowleft', 'arrowdown', 'arrowright'].includes(key)) {
            e.preventDefault(); 
            pacman.nextDir = 
                key === 'w' || key === 'arrowup' ? 'up' :
                key === 's' || key === 'arrowdown' ? 'down' :
                key === 'a' || key === 'arrowleft' ? 'left' :
                'right';
        }
    });

    // Kontrol Tombol Mobile
    document.querySelectorAll('.control-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
             if (!gameRunning) return;
             const key = e.currentTarget.getAttribute('data-key');
             pacman.nextDir = 
                key === 'w' ? 'up' :
                key === 's' ? 'down' :
                key === 'a' ? 'left' :
                'right';
        });
    });
    
    // Inisialisasi awal saat halaman dimuat
    window.onload = function() {
        initWeb3();
        resetGame(); // Reset game map
        switchView('leaderboard'); // Tampilkan leaderboard secara default
    };

</script>

</body>
</html>

