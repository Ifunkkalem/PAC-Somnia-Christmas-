<!--
  PAC-MAN WEB3: Sinterklas VS Grinch
  Tata Letak Profesional V2: Fully Responsive, Web3 Fixes Applied.
-->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinterklas VS Grinch | Dashboard Web3</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase (for Leaderboard storage) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, limit, onSnapshot, orderBy, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel global Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pacman-christmas-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            setLogLevel('debug'); // Aktifkan log Firebase
            const parsedConfig = JSON.parse(firebaseConfig);
            const app = initializeApp(parsedConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Fungsi untuk login
            const signIn = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Kesalahan saat otentikasi Firebase:", error);
                }
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // Jika pengguna log-out, coba masuk anonim
                    signInAnonymously(auth).then(anonUser => {
                        userId = anonUser.user.uid;
                    }).catch(err => {
                        console.error("Gagal masuk anonim:", err);
                        userId = 'guest-' + crypto.randomUUID(); // Fallback ID
                    });
                }
                isAuthReady = true;
                // Panggil fungsi yang bergantung pada Auth setelah otentikasi
                if (window.initApp) {
                    window.initApp(db, userId);
                }
            });

            signIn();
        }

        window.firebaseData = {
            getDb: () => db,
            getUserId: () => userId,
            isAuthReady: () => isAuthReady,
            getAppId: () => appId,
        };
    </script>
    <!-- Ethers.js for Web3 interaction -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d172a; /* Dark Blue Primary Background */
            color: #ffffff;
            min-height: 100vh;
        }
        
        /* Kontainer Utama Dashboard */
        #main-layout {
            display: flex;
            flex-direction: column; /* Mobile: Stacks vertically */
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #1a2c42; /* Kontainer Lebih Cerah */
        }
        
        /* Desktop/Tablet Layout: Dua Bilah */
        @media (min-width: 768px) {
            #main-layout {
                flex-direction: row; /* Desktop: Two columns */
                min-height: 90vh;
                margin: 5vh auto;
                border-radius: 16px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
                overflow: hidden;
            }
        }

        /* Panel Kiri (Sidebar/Kontrol) */
        #left-panel {
            background-color: #112033; /* Warna Sidebar Lebih Gelap */
            padding: 24px;
            flex-shrink: 0;
            width: 100%;
            border-bottom: 3px solid #cc0000;
        }
        @media (min-width: 768px) {
            #left-panel {
                width: 320px; /* Lebar tetap untuk desktop */
                border-right: 3px solid #cc0000;
                border-bottom: none;
                overflow-y: auto; 
            }
        }
        
        /* Panel Kanan (Konten Utama) */
        #right-panel {
            flex-grow: 1;
            padding: 32px;
            background-color: #1a2c42;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        canvas {
            background-color: #2c4766;
            display: block;
            border: 4px solid #cc0000; 
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
            width: 100%;
            height: auto;
            max-width: 400px; 
            aspect-ratio: 1 / 1; /* Pastikan selalu kotak */
        }

        /* Styling Tombol */
        .btn-primary {
            background-color: #16a34a;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 4px #0f763e;
        }
        .btn-primary:hover { background-color: #15803d; }
        .btn-primary:active { box-shadow: none; transform: translateY(4px); }
        .btn-primary:disabled { background-color: #4b5563; box-shadow: none; cursor: not-allowed; }

        .btn-secondary {
            background-color: #cc0000;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 4px #990000;
        }
        .btn-secondary:hover { background-color: #990000; }
        .btn-secondary:active { box-shadow: none; transform: translateY(4px); }
        .btn-secondary:disabled { background-color: #7f1d1d; box-shadow: none; cursor: not-allowed; }

        .control-btn {
            background-color: #3b82f6;
            width: 45px;
            height: 45px;
            border-radius: 8px;
            font-size: 18px;
            box-shadow: 0 3px #2563eb;
        }
        .control-btn:active { box-shadow: none; transform: translateY(3px); background-color: #1d4ed8; }
        
        /* Styling Leaderboard */
        .leaderboard-item {
            background-color: #2c4766;
            transition: all 0.1s;
        }
        .leaderboard-item.current-user {
            background-color: #990000 !important;
            border: 2px solid #facc15;
        }
        .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        /* Modal Styling */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: #112033; padding: 30px; border-radius: 12px; max-width: 90%; width: 400px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>

    <div id="main-layout">
        
        <!-- ========================================================= -->
        <!-- BILAH KIRI: SIDEBAR KONTROL -->
        <!-- ========================================================= -->
        <div id="left-panel">
            <h1 class="text-3xl font-extrabold text-center mb-6 text-[#facc15] border-b pb-4 border-gray-600">
                <span class="text-[#16a34a]">SINTERKLAS</span> vs <span class="text-[#cc0000]">GRINCH</span>
            </h1>
            
            <div class="space-y-6 mb-8">
                
                <!-- Status Koneksi & Web3 -->
                <div id="connection-status-info" class="p-4 rounded-xl bg-[#2c4766] shadow-xl">
                    <p class="font-bold text-lg mb-2 text-[#facc15]">Status Jaringan</p>
                    <div id="network-status" class="text-sm font-semibold text-red-400 mb-3">Memeriksa Jaringan...</div>

                    <button id="connect-wallet-btn" class="w-full btn-primary">
                        <span id="wallet-status">Hubungkan Dompet Web3</span>
                    </button>
                    
                    <!-- Detail Dompet -->
                    <div id="wallet-details" class="hidden text-sm mt-4 space-y-1 text-gray-200">
                        <div class="truncate font-mono">Alamat: <span id="connected-address" class="text-yellow-300 font-medium"></span></div>
                        <div id="user-balance" class="font-semibold">Saldo: Memuat...</div>
                    </div>
                </div>

                <!-- Kontrol Game -->
                <div id="game-controls" class="space-y-3 p-4 rounded-xl bg-[#cc0000] shadow-xl">
                     <p class="font-extrabold text-xl text-white">Sesi Bermain</p>
                     
                     <input type="text" id="display-name-input" placeholder="Nama Tampilan (Max 20 Karakter)" maxlength="20" class="w-full p-3 rounded-lg bg-[#1a2c42] text-white border border-gray-400 focus:ring-2 focus:ring-[#facc15]">
                     
                     <button id="start-game-btn" class="w-full btn-primary disabled:bg-gray-500 disabled:shadow-none" disabled>
                         MULAI BERMAIN / SESI BARU
                     </button>
                     <div class="text-sm text-center text-gray-200 font-medium">
                         Biaya Mulai: <span id="start-fee-display">0.01</span> SOMI
                     </div>
                </div>
            </div>
            
            <!-- Navigasi View -->
            <div class="border-t pt-4 border-gray-600">
                <p class="font-bold text-lg mb-3">Tampilan Konten:</p>
                <div class="flex space-x-3">
                    <button id="nav-leaderboard" class="flex-1 btn-secondary" onclick="switchView('leaderboard')">
                        Peringkat
                    </button>
                    <button id="nav-game" class="flex-1 btn-primary" onclick="switchView('game')" disabled>
                        Game
                    </button>
                </div>
                <div class="text-xs text-gray-400 mt-4 italic">
                     <span class="font-mono">UID Anda (DB): <span id="user-firebase-id">Memuat...</span></span>
                </div>
            </div>
        </div>
        
        <!-- ========================================================= -->
        <!-- BILAH KANAN: KONTEN UTAMA (Leaderboard / Game) -->
        <!-- ========================================================= -->
        <div id="right-panel">
            <div id="content-panel" class="w-full h-full flex flex-col items-center">
            
                <!-- 1. Tampilan Papan Peringkat (Default) -->
                <div id="leaderboard-view" class="w-full max-w-2xl">
                    <h2 class="text-3xl font-extrabold text-center mb-8 text-[#facc15] border-b pb-2">PAPAN PERINGKAT üèÜ</h2>
                    <div id="leaderboard-list" class="space-y-3">
                        <!-- Data peringkat akan dimuat di sini -->
                        <div class="text-center text-gray-300 p-6 rounded-lg bg-[#2c4766] animate-pulse">Memuat peringkat terbaik...</div>
                    </div>
                </div>
                
                <!-- 2. Tampilan Game (Tersembunyi Awalnya) -->
                <div id="game-view" class="w-full max-w-lg hidden flex flex-col items-center">
                    <h2 class="text-3xl font-extrabold mb-6 text-[#facc15]">KANVAS BERMAIN</h2>
                    
                    <div class="flex justify-between items-center w-full max-w-[400px] mb-4 p-2 rounded-lg bg-[#112033] shadow-inner">
                        <div class="text-xl font-extrabold text-[#16a34a]">SKOR: <span id="current-score-display">0</span></div>
                        <div id="game-message" class="text-xl font-extrabold text-red-500" style="display:none;"></div>
                    </div>
                    
                    <canvas id="pacman-canvas"></canvas>
                    
                    <!-- Kontrol Tombol Mobile/Sentuh -->
                    <div class="flex flex-col items-center mt-8">
                        <p class="text-md font-bold mb-3 text-gray-300">Kontrol Sentuh (Gunakan tombol ini di ponsel)</p>
                        <div class="grid grid-cols-3 gap-4 w-52">
                            <div></div>
                            <button class="control-btn" data-key="w">‚ñ≤</button>
                            <div></div>
                            <button class="control-btn" data-key="a">‚óÄ</button>
                            <button class="control-btn" data-key="s">‚ñº</button>
                            <button class="control-btn" data-key="d">‚ñ∂</button>
                        </div>
                        <p class="text-sm text-gray-400 mt-4 italic">Gunakan WASD atau Tombol Panah di keyboard Anda.</p>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>

    <!-- Modal Pesan Kustom -->
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-[#facc15]">Pesan</h3>
            <p id="modal-message" class="mb-6 text-gray-200"></p>
            <div class="flex flex-col space-y-3">
                <button id="modal-network-btn" class="btn-secondary hidden">Pindah ke Somnia Mainnet (5031)</button>
                <button id="modal-close-btn" class="btn-primary">Tutup</button>
            </div>
        </div>
    </div>

<script>
    // ====================================================================
    // 1. KONFIGURASI WEB3 & FIREBASE
    // ====================================================================

    // ALAMAT KONTRAK YANG DIKOREKSI MENGGUNAKAN CHECKSUM EIP-55
    const CONTRACT_ADDRESS = "0xD76b767102f2610b0C97FEE84873c1fAA4c7C365"; 
    // Chain ID yang BENAR: 5031
    const REQUIRED_CHAIN_ID = 5031; 
    const REQUIRED_NETWORK_NAME = "Somnia Mainnet";
    const REQUIRED_NETWORK_PARAMS = [{
        chainId: '0x13a7', // 5031 dalam Hex
        chainName: REQUIRED_NETWORK_NAME,
        nativeCurrency: {
            name: 'SOMI',
            symbol: 'SOMI',
            decimals: 18
        },
        rpcUrls: ['https://somnia-rpc.publicnode.com'], 
        blockExplorerUrls: ['https://explorer.somnia.network']
    }];
    
    // ABI (Application Binary Interface) yang disederhanakan
    const CONTRACT_ABI = [
        "function startGame(string memory _username) public payable returns (uint256)",
        "function submitScore(uint256 _score, uint256 _gameId, string memory _username) public",
        "function startFeeWei() view returns (uint256)",
        "event GameStarted(address indexed player, uint256 gameId, uint256 timestamp)",
        "event ScoreSubmitted(address indexed player, uint256 score, uint256 totalScore, uint256 timestamp)",
    ];

    // Status Web3
    let provider = null;
    let signer = null;
    let contract = null;
    let userAddress = null;
    let userBalance = "0";
    let gameId = 0; 
    let startFeeWei = ethers.BigNumber.from(0); // Akan diisi dari kontrak
    
    // Nilai 0.01 SOMI dalam Wei (Sebagai referensi, walau kita ambil dari kontrak)
    const START_FEE_REFERENCE = ethers.utils.parseEther("0.01");


    // Status Firebase
    let db = null;
    let firebaseUserId = null;
    let appId = null;
    const LEADERBOARD_COLLECTION = "leaderboard";

    // ====================================================================
    // 2. UTILITAS & UI MANAGEMENT
    // ====================================================================
    
    let currentView = 'leaderboard'; 

    /** Mengganti tampilan konten utama */
    function switchView(viewName) {
        if (viewName === 'game' && !document.getElementById('start-game-btn').disabled) {
             // Izinkan pengguna melihat tampilan game, tetapi ingatkan untuk memulai
             if (!gameRunning) {
                // Biarkan mereka melihatnya, tapi game belum jalan
             }
        }

        currentView = viewName;
        document.getElementById('leaderboard-view').classList.toggle('hidden', viewName !== 'leaderboard');
        document.getElementById('game-view').classList.toggle('hidden', viewName !== 'game');
        
        document.getElementById('nav-leaderboard').classList.toggle('bg-red-700', viewName === 'leaderboard');
        document.getElementById('nav-leaderboard').classList.toggle('bg-[#cc0000]', viewName !== 'leaderboard');
        
        document.getElementById('nav-game').classList.toggle('bg-green-700', viewName === 'game');
        document.getElementById('nav-game').classList.toggle('bg-[#16a34a]', viewName !== 'game');

        if (viewName === 'game') {
            // Memastikan kanvas di-redraw jika beralih kembali ke tampilan game
            drawMap();
            drawPacman();
            drawGhosts();
        }
    }

    /** Menampilkan modal pesan kustom */
    function showModal(title, message, isNetworkError = false) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').innerHTML = message;
        document.getElementById('modal-network-btn').classList.toggle('hidden', !isNetworkError);
        document.getElementById('custom-modal').classList.remove('hidden');
        
        document.getElementById('modal-close-btn').onclick = () => {
            document.getElementById('custom-modal').classList.add('hidden');
        };
        
        if (isNetworkError) {
             document.getElementById('modal-network-btn').onclick = addSomniaNetwork;
        }
    }
    
    /** Mencoba menambahkan atau beralih ke Somnia Mainnet melalui dompet */
    async function addSomniaNetwork() {
        if (!window.ethereum) {
            showModal("Kesalahan", "Anda perlu dompet Web3 (seperti MetaMask) untuk menggunakan fitur ini.");
            return;
        }
        
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0x13a7' }],
            });
            // Reload untuk inisialisasi ulang Web3 setelah beralih jaringan
            window.location.reload(); 
        } catch (switchError) {
            if (switchError.code === 4902) { // Jaringan belum ada, coba tambahkan
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: REQUIRED_NETWORK_PARAMS,
                    });
                    window.location.reload();
                } catch (addError) {
                    showModal("Gagal Menambahkan Jaringan", `Gagal menambahkan ${REQUIRED_NETWORK_NAME}. Pesan: ${addError.message || 'Unknown Error'}`);
                }
            } else {
                showModal("Gagal Beralih Jaringan", `Terjadi kesalahan saat beralih jaringan. Pesan: ${switchError.message || 'User Denied/Unknown Error'}`);
            }
        }
    }


    /** Memperbarui tampilan UI dompet */
    function updateWalletUI() {
        const connectBtn = document.getElementById('connect-wallet-btn');
        const walletDetails = document.getElementById('wallet-details');
        const networkStatus = document.getElementById('network-status');
        const startGameBtn = document.getElementById('start-game-btn');
        const navGameBtn = document.getElementById('nav-game');

        // Gunakan nilai startFeeWei yang diambil dari kontrak (seharusnya 0.01 SOMI)
        document.getElementById('start-fee-display').textContent = ethers.utils.formatEther(startFeeWei);

        if (userAddress && provider && contract) { // Kontrak hanya ada jika Jaringan Benar
            // Sukses Terkoneksi ke Jaringan Somnia
            connectBtn.classList.add('hidden');
            walletDetails.classList.remove('hidden');
            startGameBtn.disabled = false;
            navGameBtn.disabled = false;

            document.getElementById('connected-address').textContent = userAddress.substring(0, 6) + "..." + userAddress.substring(userAddress.length - 4);
            document.getElementById('user-balance').textContent = `Saldo: ${parseFloat(userBalance).toFixed(4)} SOMI`;
            
            networkStatus.textContent = `${REQUIRED_NETWORK_NAME} (Terkoneksi)`;
            networkStatus.classList.remove('text-red-400');
            networkStatus.classList.add('text-green-400');

        } else if (provider) {
             // Dompet Terhubung, tapi Jaringan salah (kontrak belum diinisialisasi)
            connectBtn.classList.remove('hidden');
            document.getElementById('wallet-status').textContent = "Jaringan Salah, Klik untuk Perbaiki";
            walletDetails.classList.add('hidden');
            startGameBtn.disabled = true;
            navGameBtn.disabled = true;

            networkStatus.textContent = `Peringatan: Pindah ke ${REQUIRED_NETWORK_NAME} (5031)`;
            networkStatus.classList.add('text-red-400');
            networkStatus.classList.remove('text-green-400');

        } else {
            // Belum Terkoneksi sama sekali / Gagal Total
            connectBtn.classList.remove('hidden');
            document.getElementById('wallet-status').textContent = "Hubungkan Dompet Web3";
            walletDetails.classList.add('hidden');
            startGameBtn.disabled = true;
            navGameBtn.disabled = true;

            networkStatus.textContent = "Tidak Terhubung ke Wallet/Jaringan";
            networkStatus.classList.add('text-red-400');
            networkStatus.classList.remove('text-green-400');
        }
    }

    // ====================================================================
    // 3. FUNGSI WEB3 (APLIKASI FIX CHECK SUM DAN VALUE)
    // ====================================================================

    /** Menginisialisasi koneksi Web3 (MetaMask/Provider) */
    async function initWeb3() {
    if (!window.ethereum) {
        showModal("Kesalahan", "MetaMask / Wallet tidak ditemukan.");
        return;
    }

    try {
        document.getElementById('wallet-status').textContent = "Menghubungkan...";

        const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts'
        });

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer   = provider.getSigner();
        userAddress = accounts[0];

        const network = await provider.getNetwork();

        if (network.chainId !== REQUIRED_CHAIN_ID) {
            provider = null;
            signer   = null;
            contract = null;

            updateWalletUI();

            showModal(
                "Jaringan Salah",
                `Silakan pindah ke <b>${REQUIRED_NETWORK_NAME}</b> (5031)`,
                true
            );
            return;
        }

        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        // ‚úÖ Ambil saldo langsung dari blockchain
        const balanceWei = await provider.getBalance(userAddress);
        userBalance = ethers.utils.formatEther(balanceWei);

        // ‚úÖ Ambil fee dari kontrak langsung
        startFeeWei = await contract.startFeeWei();

        updateWalletUI();

        window.ethereum.on("accountsChanged", () => location.reload());
        window.ethereum.on("chainChanged", () => location.reload());

    } catch (err) {
        console.error("Wallet Error:", err);

        provider = null;
        signer   = null;
        contract = null;
        userAddress = null;

        updateWalletUI();

        if (err.code === 4001) {
            showModal("Dibatalkan", "Koneksi dompet dibatalkan user.");
        } else {
            showModal("Gagal", err.message);
        }
    }
          }

            // 3. JARINGAN BENAR: Lanjutkan inisialisasi
            // PENTING: Alamat kontrak yang dikoreksi (Checksum) digunakan di sini
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            
            // Ambil saldo dan biaya
            const [balanceWei, feeWei] = await Promise.all([
                provider.getBalance(userAddress),
                contract.startFeeWei()
            ]);
            
            userBalance = ethers.utils.formatEther(balanceWei);
            startFeeWei = feeWei;

            updateWalletUI();

            // 4. Dengarkan perubahan (Untuk menangani error di masa depan)
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());

        } catch (error) {
            console.error("Kesalahan saat koneksi dompet:", error);
            
            // Pastikan state selalu bersiasync function startGameTx() {
    if (!contract || !signer) {
        showModal("Error", "Wallet belum terkoneksi.");
        return;
    }

    const username = document.getElementById('display-name-input').value.trim() || "Anon";

    try {
        // ‚úÖ Ambil saldo LANGSUNG saat transaksi
        const freshBalanceWei = await provider.getBalance(userAddress);

        if (freshBalanceWei.lt(startFeeWei)) {
            showModal("Saldo Kurang", "Minimal saldo 0.01 SOMI");
            return;
        }

        const btn = document.getElementById('start-game-btn');
        btn.innerHTML = "Menunggu konfirmasi...";
        btn.disabled = true;

        const tx = await contract.startGame(username, {
            value: startFeeWei
        });

        showModal("TX Dikirim", `Hash: ${tx.hash}`);

        const receipt = await tx.wait();

        const event = receipt.events.find(e => e.event === "GameStarted");
        gameId = event.args.gameId.toNumber();

        btn.innerHTML = "MULAI LAGI";
        btn.disabled = false;

        switchView("game");
        resetGame();
        startGameLoop();

    } catch (err) {
        console.error("TX ERROR:", err);

        document.getElementById('start-game-btn').disabled = false;
        document.getElementById('start-game-btn').innerHTML = "MULAI BERMAIN";

        if (err.code === 4001) {
            showModal("Dibatalkan", "Transaksi dibatalkan user.");
        } else {
            showModal("Gagal", err.reason || err.message);
        }
    }
  }h pada kegagalan
            userAddress = null;
            provider = null;
            contract = null;
            updateWalletUI();
            
            let errorMessage = error.message || error.code;
            if (error.code === 4001) {
                errorMessage = "Anda menolak permintaan koneksi dompet.";
            }

            showModal("Koneksi Gagal", `Terjadi kesalahan saat menghubungkan dompet: ${errorMessage}.`);
        }
    }

    /** Memulai sesi game melalui kontrak pintar, mengirim 0.01 SOMI */
    

    /** Mengirim skor akhir ke kontrak pintar */
    async function submitScoreTx(finalScore) {
        if (!contract || !gameId) {
            console.error("Tidak ada kontrak atau Game ID.");
            return;
        }

        const username = document.getElementById('display-name-input').value.trim() || 'AnonPlayer';

        try {
            showModal("Mengirim Skor", `Skor ${finalScore} Anda sedang dikirim ke blockchain. Harap tunggu...`);
            
            const tx = await contract.submitScore(finalScore, gameId, username);
            
            const receipt = await tx.wait();
            console.log("Transaksi submitScore berhasil:", receipt);

            const scoreSubmittedEvent = receipt.events.find(e => e.event === 'ScoreSubmitted');
            let newTotalScore = finalScore;
            if (scoreSubmittedEvent) {
                // Ambil total skor dari event untuk sinkronisasi Firetore
                newTotalScore = scoreSubmittedEvent.args.totalScore.toNumber(); 
            }

            // Simpan ke Firestore
            await saveScoreToFirestore(newTotalScore, username);
            
            showModal("Skor Berhasil Dikirim!", `Skor akhir (${finalScore}) berhasil dicatat di blockchain! Total Skor Akumulasi Anda: ${newTotalScore.toLocaleString()}.`);

        } catch (error) {
            console.error("Transaksi submitScore Gagal:", error);
            
            let errorMessage = error.code === 4001 ? "Anda membatalkan pengiriman skor." : (error.data?.message || error.reason || "Gagal mengirim skor.");
            showModal("Pengiriman Skor Gagal", `Pesan Kesalahan: ${errorMessage}`);
        }
    }


    // ====================================================================
    // 4. FUNGSI FIREBASE (Leaderboard)
    // ====================================================================

    /** Fungsi untuk inisialisasi Firebase dari luar (dipanggil setelah auth siap) */
    window.initApp = (firestoreInstance, currentUserId) => {
        db = firestoreInstance;
        firebaseUserId = currentUserId;
        appId = window.firebaseData.getAppId();
        document.getElementById('user-firebase-id').textContent = firebaseUserId;
        loadLeaderboard();
    };

    /** Memuat 10 Peringkat Teratas */
    function loadLeaderboard() {
        if (!db || !appId) return;
        
        const q = query(
            collection(db, "artifacts", appId, "public", "data", LEADERBOARD_COLLECTION),
            orderBy("totalScore", "desc"),
            limit(10)
        );

        onSnapshot(q, (snapshot) => {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            
            if (snapshot.empty) {
                leaderboardList.innerHTML = '<div class="text-center text-gray-300 p-6 rounded-lg bg-[#2c4766]">Jadilah yang pertama untuk mencetak skor!</div>';
                return;
            }

            snapshot.forEach((doc, index) => {
                const data = doc.data();
                const scoreItem = document.createElement('div');
                // Menggunakan firebaseUserId untuk menandai pengguna saat ini
                const isCurrentUser = data.userId === firebaseUserId; 
                scoreItem.className = 'leaderboard-item flex justify-between items-center p-3 rounded-xl shadow-md transition-all ' + (isCurrentUser ? 'current-user' : '');
                
                scoreItem.innerHTML = `
                    <span class="font-extrabold text-2xl text-[#facc15] w-8">${index + 1}.</span>
                    <span class="flex-grow mx-4 text-left font-semibold truncate">
                        ${data.username || 'Pemain Anonim'} 
                        <span class="text-xs ${isCurrentUser ? 'text-yellow-200' : 'text-gray-400'} block">${isCurrentUser ? '(ANDA)' : `UID: ${data.userId.substring(0, 8)}...`}</span>
                    </span>
                    <span class="font-extrabold text-xl text-white">${data.totalScore.toLocaleString()}</span>
                `;
                leaderboardList.appendChild(scoreItem);
            });
        }, (error) => {
             console.error("Gagal memuat leaderboard dari Firestore:", error);
             document.getElementById('leaderboard-list').innerHTML = '<div class="text-center text-red-400 p-4">Gagal memuat Leaderboard. Periksa konsol.</div>';
        });
    }

    /** Menyimpan skor akumulasi total ke Firestore (dipanggil SETELAH sukses di blockchain) */
    async function saveScoreToFirestore(newTotalScore, username) {
        if (!db || !appId || !firebaseUserId) {
            console.error("Firestore belum siap untuk menyimpan skor.");
            return;
        }

        try {
            const docRef = doc(db, "artifacts", appId, "public", "data", LEADERBOARD_COLLECTION, firebaseUserId);

            await setDoc(docRef, {
                userId: firebaseUserId,
                username: username,
                totalScore: newTotalScore,
                lastUpdated: new Date().toISOString()
            }, { merge: true }); 

        } catch (error) {
            console.error("Gagal menyimpan skor ke Firestore:", error);
        }
    }

    // ====================================================================
    // 5. LOGIKA GAME (PAC-MAN)
    // ====================================================================

    const canvas = document.getElementById('pacman-canvas');
    const ctx = canvas.getContext('2d');
    const TILE_SIZE = 20;
    // Peta Game
    const GAME_MAP = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
        [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
        [1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
        [0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
        [1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
        [1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
        [1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];
    const MAP_WIDTH = GAME_MAP[0].length;
    const MAP_HEIGHT = GAME_MAP.length;
    
    // Set ukuran Kanvas
    canvas.width = MAP_WIDTH * TILE_SIZE;
    canvas.height = MAP_HEIGHT * TILE_SIZE;

    // Game state
    let pacman = { x: 1, y: 1, dir: 'right', nextDir: 'right', radius: TILE_SIZE / 2.5 };
    let ghosts = [
        { x: 9, y: 9, color: '#cc0000', dir: 'up', speed: 1 }, // Grinch Merah
        { x: 10, y: 9, color: '#16a34a', dir: 'down', speed: 1 }, // Grinch Hijau
    ];
    let score = 0;
    let gameRunning = false;
    let mapData = [];
    let animationFrameId = null;

    function resetMapData() {
        mapData = GAME_MAP.map(row => [...row]);
        score = 0;
        pacman = { x: 1, y: 1, dir: 'right', nextDir: 'right', radius: TILE_SIZE / 2.5 };
        ghosts = [
            { x: 9, y: 9, color: '#cc0000', dir: 'up', speed: 1 }, 
            { x: 10, y: 9, color: '#16a34a', dir: 'down', speed: 1 }, 
        ];
    }

    function resetGame() {
        resetMapData();
        document.getElementById('current-score-display').textContent = score;
        document.getElementById('game-message').style.display = 'none';
        gameRunning = true;
    }

    function drawMap() {
        for (let y = 0; y < MAP_HEIGHT; y++) {
            for (let x = 0; x < MAP_WIDTH; x++) {
                const type = mapData[y][x];
                
                if (type === 1) { // Tembok (Wall) - Desain Tembok Santa Merah
                    ctx.fillStyle = '#cc0000'; 
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    ctx.strokeStyle = '#ffffff'; 
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                } else {
                    ctx.fillStyle = '#1a2c42'; 
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);

                    if (type === 2) { // Pellet (Hadiah/Koin)
                        ctx.fillStyle = '#facc15'; 
                        ctx.beginPath();
                        ctx.arc(x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + TILE_SIZE / 2, TILE_SIZE / 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
        }
    }

    function drawPacman() {
        // Santa Claus (Pacman) - Kuning Emas
        const x = pacman.x * TILE_SIZE + TILE_SIZE / 2;
        const y = pacman.y * TILE_SIZE + TILE_SIZE / 2;
        ctx.fillStyle = '#facc15'; 
        ctx.beginPath();
        
        const mouthOpen = Math.abs(Math.sin(Date.now() / 100));
        const angleOffset = { 'right': 0, 'left': Math.PI, 'up': -Math.PI / 2, 'down': Math.PI / 2 }[pacman.dir];
        const startAngle = angleOffset + mouthOpen * 0.4;
        const endAngle = angleOffset - mouthOpen * 0.4 + 2 * Math.PI;

        ctx.arc(x, y, pacman.radius, startAngle, endAngle, false);
        ctx.lineTo(x, y);
        ctx.closePath();
        ctx.fill();
    }

    function drawGhosts() {
        // Grinch (Hantu)
        ghosts.forEach(ghost => {
            const x = ghost.x * TILE_SIZE + TILE_SIZE / 2;
            const y = ghost.y * TILE_SIZE + TILE_SIZE / 2;
            
            ctx.fillStyle = ghost.color;
            ctx.beginPath();
            // Badan
            ctx.arc(x, y, TILE_SIZE / 2, Math.PI, 0, false);
            ctx.rect(x - TILE_SIZE / 2, y, TILE_SIZE, TILE_SIZE / 2);
            // Kaki (Wiggle)
            const wobble = Math.sin(Date.now() / 200) * 2;
            ctx.moveTo(x - TILE_SIZE / 2, y + TILE_SIZE / 2);
            ctx.lineTo(x - TILE_SIZE / 2 + TILE_SIZE / 4 + wobble, y + TILE_SIZE / 2 - 3);
            ctx.lineTo(x, y + TILE_SIZE / 2);
            ctx.lineTo(x + TILE_SIZE / 2 - TILE_SIZE / 4 - wobble, y + TILE_SIZE / 2 - 3);
            ctx.lineTo(x + TILE_SIZE / 2, y + TILE_SIZE / 2);
            ctx.fill();
            
            // Mata
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(x - TILE_SIZE / 4, y - TILE_SIZE / 4, TILE_SIZE / 8, 0, Math.PI * 2);
            ctx.arc(x + TILE_SIZE / 4, y - TILE_SIZE / 4, TILE_SIZE / 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Pupil
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(x - TILE_SIZE / 4 + 1, y - TILE_SIZE / 4, TILE_SIZE / 16, 0, Math.PI * 2);
            ctx.arc(x + TILE_SIZE / 4 + 1, y - TILE_SIZE / 4, TILE_SIZE / 16, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function movePacman() {
        const nextX = pacman.x + (pacman.nextDir === 'right' ? 1 : pacman.nextDir === 'left' ? -1 : 0);
        const nextY = pacman.y + (pacman.nextDir === 'down' ? 1 : pacman.nextDir === 'up' ? -1 : 0);

        if (mapData[nextY] && mapData[nextY][nextX] !== 1) {
            pacman.dir = pacman.nextDir;
            pacman.x = nextX;
            pacman.y = nextY;
        } else {
            const currentX = pacman.x + (pacman.dir === 'right' ? 1 : pacman.dir === 'left' ? -1 : 0);
            const currentY = pacman.y + (pacman.dir === 'down' ? 1 : pacman.dir === 'up' ? -1 : 0);

            if (mapData[currentY] && mapData[currentY][currentX] !== 1) {
                pacman.x = currentX;
                pacman.y = currentY;
            }
        }
        
        // Teleport
        if (pacman.x < 0) pacman.x = MAP_WIDTH - 1;
        if (pacman.x >= MAP_WIDTH) pacman.x = 0;
    }

    function moveGhosts() {
        ghosts.forEach(ghost => {
            const possibleMoves = [];
            const moves = [
                { dx: 1, dy: 0, dir: 'right' },
                { dx: -1, dy: 0, dir: 'left' },
                { dx: 0, dy: 1, dir: 'down' },
                { dx: 0, dy: -1, dir: 'up' }
            ];

            moves.forEach(move => {
                const nextX = ghost.x + move.dx;
                const nextY = ghost.y + move.dy;
                
                if (mapData[nextY] && mapData[nextY][nextX] !== 1) {
                    possibleMoves.push(move);
                }
            });

            if (possibleMoves.length > 0) {
                const move = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                ghost.x += move.dx;
                ghost.y += move.dy;
                ghost.dir = move.dir;
            }
        });
    }
    
    function checkCollision() {
        // Cek dot
        if (mapData[pacman.y][pacman.x] === 2) {
            mapData[pacman.y][pacman.x] = 0; 
            score += 10;
            document.getElementById('current-score-display').textContent = score;

            let dotsRemaining = mapData.flat().filter(cell => cell === 2).length;
            if (dotsRemaining === 0) {
                endGame("SELAMAT! Anda menang dan membersihkan semua hadiah!", true);
            }
        }

        // Cek hantu
        ghosts.forEach(ghost => {
            if (pacman.x === ghost.x && pacman.y === ghost.y) {
                endGame("Misi Gagal! Grinch berhasil mencuri semua hadiah!", false);
            }
        });
    }

    function endGame(message, isWin) {
        if (!gameRunning) return;
        gameRunning = false;
        cancelAnimationFrame(animationFrameId);
        
        document.getElementById('game-message').textContent = message;
        document.getElementById('game-message').style.display = 'block';
        
        // Kirim skor jika skor > 0 atau jika menang
        if (score > 0 || isWin) {
            submitScoreTx(score);
        } else {
             // Jika skor 0, hanya tampilkan pesan akhir game
             showModal("Game Berakhir", message + " Skor Anda: 0. Skor tidak dikirim ke leaderboard.");
        }

        // Kembali ke tampilan leaderboard setelah 5 detik
        setTimeout(() => {
            document.getElementById('game-message').style.display = 'none';
            switchView('leaderboard');
        }, 5000);
    }

    let lastTime = 0;
    const GAME_UPDATE_INTERVAL = 150; 
    let gameUpdateTimer = 0;

    function gameLoop(timestamp) {
        if (!gameRunning) return;

        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMap();
        drawPacman();
        drawGhosts();
        
        gameUpdateTimer += deltaTime;
        if (gameUpdateTimer > GAME_UPDATE_INTERVAL) {
            movePacman();
            moveGhosts(); 
            checkCollision();
            gameUpdateTimer = 0;
        }

        animationFrameId = requestAnimationFrame(gameLoop);
    }
    
    function startGameLoop() {
        gameRunning = true;
        lastTime = performance.now();
        gameLoop(lastTime);
    }

    // ====================================================================
    // 6. EVENT LISTENERS
    // ====================================================================

    // Tombol Koneksi
    document.getElementById('connect-wallet-btn').addEventListener('click', initWeb3);

    // Tombol Mulai Game
    document.getElementById('start-game-btn').addEventListener('click', startGameTx);

    // Kontrol Keyboard
    document.addEventListener('keydown', (e) => {
        if (!gameRunning) return;
        const key = e.key.toLowerCase();
        if (['w', 'a', 's', 'd', 'arrowup', 'arrowleft', 'arrowdown', 'arrowright'].includes(key)) {
            e.preventDefault(); 
            pacman.nextDir = 
                key === 'w' || key === 'arrowup' ? 'up' :
                key === 's' || key === 'arrowdown' ? 'down' :
                key === 'a' || key === 'arrowleft' ? 'left' :
                'right';
        }
    });

    // Kontrol Tombol Mobile
    document.querySelectorAll('.control-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
             if (!gameRunning) return;
             const key = e.currentTarget.getAttribute('data-key');
             pacman.nextDir = 
                key === 'w' ? 'up' :
                key === 's' ? 'down' :
                key === 'a' ? 'left' :
                'right';
        });
    });
    
    // Inisialisasi awal saat halaman dimuat
    window.onload = function() {
        initWeb3();
        resetGame(); // Reset game map
        switchView('leaderboard'); // Tampilkan leaderboard secara default
    };

</script>

</body>
</html>

