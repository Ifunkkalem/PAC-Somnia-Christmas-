<!--
  PAC-MAN WEB3: Sinterklas VS Grinch
  Dibuat menggunakan HTML, Tailwind CSS, dan JavaScript murni.
  Mengintegrasikan koneksi dompet Web3 dan interaksi kontrak pintar
  untuk memulai permainan dan mengirim skor.
-->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinterklas VS Grinch ðŸŽ„</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase (for Leaderboard storage) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, limit, onSnapshot, orderBy, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables will be defined here by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pacman-christmas-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            setLogLevel('debug'); // Aktifkan log Firebase
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Fungsi untuk login
            const signIn = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Kesalahan saat otentikasi Firebase:", error);
                }
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    userId = null;
                }
                isAuthReady = true;
                // Panggil fungsi yang bergantung pada Auth setelah otentikasi
                if (window.initApp) {
                    window.initApp(db, userId);
                }
            });

            signIn();
        }

        window.firebaseData = {
            getDb: () => db,
            getUserId: () => userId,
            isAuthReady: () => isAuthReady,
            getAppId: () => appId,
        };
    </script>
    <!-- Ethers.js for Web3 interaction -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b1a2a; /* Dark Blue Christmas Theme */
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        .container {
            max-width: 400px;
            width: 100%;
            margin-top: 20px;
            padding: 20px;
            background-color: #1a2c42; /* Darker panel background */
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        canvas {
            background-color: #2c4766;
            display: block;
            border: 4px solid #cc0000; /* Red border */
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        .btn-green {
            background-color: #16a34a;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            transition: background-color 0.2s;
            cursor: pointer;
            box-shadow: 0 4px #0f763e;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .btn-green:hover {
            background-color: #15803d;
        }
        .btn-green:active {
            box-shadow: none;
            transform: translateY(4px);
        }
        .btn-blue {
            background-color: #2563eb;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            box-shadow: 0 4px #1d4ed8;
            cursor: default;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: #2c4766;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .control-btn {
            background-color: #3b82f6;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            transition: background-color 0.1s, transform 0.1s;
            box-shadow: 0 3px #2563eb;
            cursor: pointer;
        }
        .control-btn:active {
            box-shadow: none;
            transform: translateY(3px);
            background-color: #1d4ed8;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1a2c42;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            max-width: 90%;
            border: 3px solid #cc0000;
        }
    </style>
</head>
<body>

    <div class="container mb-6">
        <h1 class="text-3xl font-bold text-center mb-6 text-[#16a34a]">SINTERKLAS VS GRINCH ðŸŽ„</h1>

        <!-- Bagian Koneksi Dompet & Input Nama -->
        <div class="space-y-4 mb-8 p-4 bg-[#2c4766] rounded-xl shadow-lg">
            <button id="connect-wallet-btn" class="w-full btn-green">
                <span id="wallet-status">Dompet Tidak Terhubung</span>
            </button>
            <div id="wallet-info" class="hidden text-center text-sm text-gray-300 bg-[#1a2c42] p-2 rounded-lg">
                Dompet Tersambung: <span id="connected-address"></span>
                <div id="user-balance">Saldo: Memuat...</div>
            </div>
            
            <input type="text" id="display-name-input" placeholder="Masukkan Nama Tampilan (Maks 20 karakter)" maxlength="20" class="w-full p-3 rounded-xl bg-[#1a2c42] text-white border border-[#16a34a] focus:ring focus:ring-[#16a34a] focus:border-[#16a34a]">
            
            <button id="start-game-btn" class="w-full btn-green disabled:bg-gray-500 disabled:shadow-none" disabled>
                MULAI BERMAIN
            </button>
        </div>
        
        <!-- Papan Skor Global -->
        <div id="leaderboard-section" class="p-4 bg-[#cc0000] rounded-xl shadow-lg">
            <h2 class="text-xl font-bold text-center mb-4 text-white">PAPAN PERINGKAT TERATAS (AKUMULASI)</h2>
            <div class="text-xs text-center mb-2 italic text-gray-200">
                ID Anda: <span id="user-firebase-id">Memuat...</span>
            </div>
            <div id="leaderboard-list">
                <!-- Data peringkat akan dimuat di sini -->
                <div class="text-center text-gray-300">Memuat peringkat...</div>
            </div>
        </div>
    </div>
    
    <!-- Bagian Game -->
    <div id="game-container" class="container" style="display:none;">
        <div class="flex justify-between items-center mb-4">
            <div class="text-lg font-bold">Skor Saat Ini: <span id="current-score-display">0</span></div>
            <div class="text-sm text-gray-400">UID Pengguna: <span id="game-user-id"></span></div>
        </div>
        <canvas id="pacman-canvas"></canvas>
        <div id="game-message" class="text-center text-xl font-bold mt-4 text-[#facc15]" style="display:none;">PERMAINAN BERLANGSUNG...</div>
        
        <!-- Kontrol Tombol Mobile -->
        <div class="flex flex-col items-center mt-6">
            <div class="grid grid-cols-3 gap-3 w-48">
                <div></div>
                <button class="control-btn" data-key="w">^</button>
                <div></div>
                <button class="control-btn" data-key="a"><</button>
                <button class="control-btn" data-key="s">v</button>
                <button class="control-btn" data-key="d">></button>
            </div>
            <p class="text-sm text-gray-400 mt-4">Anda juga bisa menggunakan tombol WASD/panah di keyboard.</p>
        </div>
    </div>

    <!-- Modal Pesan Kustom -->
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-[#facc15]">Pesan</h3>
            <p id="modal-message" class="mb-6 text-gray-200"></p>
            <button id="modal-close-btn" class="btn-green">Tutup</button>
        </div>
    </div>

<script>
    // ====================================================================
    // 1. KONFIGURASI WEB3 & FIREBASE
    // ====================================================================

    // PERBAIKAN PENTING: Mengganti alamat kontrak dengan canonical EIP-55 checksum yang benar
    // untuk mengatasi Error: bad address checksum.
    const CONTRACT_ADDRESS = "0xD76b767102F2610b0c97Fee84873C1fAA4C7c365";
    
    // ABI (Application Binary Interface) yang disederhanakan
    const CONTRACT_ABI = [
        "function startGame(string memory _username) public returns (uint256)",
        "function submitScore(uint256 _score, uint256 _gameId, string memory _username) public",
        "function startFeeWei() view returns (uint256)",
        "function maxScorePerSubmit() view returns (uint256)",
        "function players(address) view returns (uint256 totalScore, uint256 lastPlayed)",
        "event GameStarted(address indexed player, uint256 gameId, uint256 timestamp)",
        "event ScoreSubmitted(address indexed player, uint256 score, uint256 totalScore, uint256 timestamp)",
    ];

    // Status Web3
    let provider = null;
    let signer = null;
    let contract = null;
    let userAddress = null;
    let userBalance = "0";
    let gameId = 0; // ID unik untuk setiap sesi game
    let startFeeWei = ethers.BigNumber.from(0);

    // Status Firebase
    let db = null;
    let firebaseUserId = null;
    let appId = null;
    const LEADERBOARD_COLLECTION = "leaderboard";

    // ====================================================================
    // 2. UTILITAS
    // ====================================================================

    /** Menampilkan modal pesan kustom */
    function showModal(title, message) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').innerHTML = message;
        document.getElementById('custom-modal').classList.remove('hidden');
        document.getElementById('modal-close-btn').onclick = () => {
            document.getElementById('custom-modal').classList.add('hidden');
        };
    }

    /** Memperbarui tampilan UI dompet */
    function updateWalletUI() {
        const statusElement = document.getElementById('wallet-status');
        const infoElement = document.getElementById('wallet-info');
        const addressElement = document.getElementById('connected-address');
        const balanceElement = document.getElementById('user-balance');
        const startGameBtn = document.getElementById('start-game-btn');

        if (userAddress) {
            statusElement.textContent = "Dompet Terhubung: " + userAddress.substring(0, 6) + "..." + userAddress.substring(userAddress.length - 4);
            infoElement.classList.remove('hidden');
            addressElement.textContent = userAddress;
            balanceElement.textContent = `Saldo: ${userBalance} SOMI`;
            startGameBtn.disabled = false;
        } else {
            statusElement.textContent = "Dompet Tidak Terhubung";
            infoElement.classList.add('hidden');
            startGameBtn.disabled = true;
        }
    }

    // ====================================================================
    // 3. FUNGSI WEB3
    // ====================================================================

    /** Menginisialisasi koneksi Web3 (MetaMask/Provider) */
    async function initWeb3() {
        if (!window.ethereum) {
            showModal("Kesalahan", "Silakan instal MetaMask atau dompet Web3 yang kompatibel.");
            return;
        }
        
        try {
            // Meminta koneksi ke dompet
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            
            // Periksa jaringan (Somnia Mainnet) - ID 70700
            const { chainId } = await provider.getNetwork();
            if (chainId !== 70700) {
                showModal("Kesalahan Jaringan", "Silakan pindah ke **Somnia Mainnet (Chain ID 70700)** di dompet Anda.");
                userAddress = null;
                updateWalletUI();
                return;
            }

            // Inisialisasi Kontrak
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            
            // Ambil saldo
            const balanceWei = await provider.getBalance(userAddress);
            userBalance = ethers.utils.formatEther(balanceWei);
            
            // Ambil biaya mulai game
            startFeeWei = await contract.startFeeWei();

            updateWalletUI();

            // Dengarkan perubahan akun/jaringan
            window.ethereum.on('accountsChanged', (accounts) => {
                window.location.reload();
            });
            window.ethereum.on('chainChanged', (chainId) => {
                window.location.reload();
            });

        } catch (error) {
            console.error("Kesalahan saat koneksi dompet:", error);
            userAddress = null;
            updateWalletUI();
            showModal("Koneksi Gagal", `Terjadi kesalahan saat menghubungkan dompet: ${error.message || error.code}.`);
        }
    }

    /** Memulai sesi game melalui kontrak pintar */
    async function startGameTx() {
        if (!contract || !userAddress) {
            showModal("Peringatan", "Dompet belum terhubung.");
            return;
        }

        const username = document.getElementById('display-name-input').value.trim() || 'AnonPlayer';
        if (username.length > 20) {
            showModal("Peringatan", "Nama tampilan maksimal 20 karakter.");
            return;
        }
        
        // Cek saldo
        if (ethers.utils.parseEther(userBalance).lt(startFeeWei)) {
            showModal("Saldo Kurang", `Anda membutuhkan ${ethers.utils.formatEther(startFeeWei)} SOMI untuk memulai game.`);
            return;
        }

        try {
            document.getElementById('start-game-btn').textContent = "Menunggu Konfirmasi...";
            document.getElementById('start-game-btn').disabled = true;

            const tx = await contract.startGame(username, {
                value: startFeeWei // Kirim biaya mulai game
            });

            showModal("Transaksi Terkirim", `Transaksi memulai game telah dikirim. Harap tunggu konfirmasi di blockchain.`);
            
            const receipt = await tx.wait();
            console.log("Transaksi startGame berhasil:", receipt);

            // Cari event GameStarted untuk mendapatkan gameId
            const gameStartedEvent = receipt.events.find(e => e.event === 'GameStarted');
            if (gameStartedEvent) {
                gameId = gameStartedEvent.args.gameId.toNumber();
                console.log(`Game ID baru: ${gameId}`);
                showModal("Game Siap!", "Transaksi berhasil dikonfirmasi. Anda bisa mulai bermain sekarang!");
                
                // Mulai permainan setelah transaksi berhasil
                document.getElementById('start-game-btn').textContent = "MULAI BERMAIN";
                document.getElementById('start-game-btn').disabled = false;
                
                // Sembunyikan UI utama dan tampilkan game
                document.querySelector('.container').style.display = 'none';
                document.getElementById('game-container').style.display = 'block';
                document.getElementById('game-user-id').textContent = firebaseUserId;

                // Reset dan mulai permainan Pac-Man (asumsi fungsi ada di bawah)
                resetGame();
                startGameLoop();

            } else {
                throw new Error("Event GameStarted tidak ditemukan dalam transaksi.");
            }

        } catch (error) {
            console.error("Transaksi startGame Gagal:", error);
            document.getElementById('start-game-btn').textContent = "MULAI BERMAIN";
            document.getElementById('start-game-btn').disabled = false;
            
            let errorMessage = "Gagal memulai game. Coba lagi.";
            if (error.code === 4001) {
                errorMessage = "Anda membatalkan transaksi di dompet.";
            } else if (error.message.includes('bad address checksum')) {
                // Walaupun sudah diperbaiki, berikan pesan spesifik jika error terulang
                errorMessage = `Kesalahan Alamat Kontrak: ${error.message}.`;
            } else if (error.data && error.data.message) {
                 errorMessage = `Kontrak Tolak: ${error.data.message}.`;
            }
            showModal("Transaksi Gagal", `Pesan Kesalahan: ${errorMessage}`);
        }
    }

    /** Mengirim skor akhir ke kontrak pintar */
    async function submitScoreTx(finalScore) {
        if (!contract || !gameId) {
            console.error("Tidak ada kontrak atau Game ID.");
            return;
        }

        const username = document.getElementById('display-name-input').value.trim() || 'AnonPlayer';

        try {
            showModal("Mengirim Skor", "Skor Anda sedang dikirim ke blockchain. Harap tunggu konfirmasi.");
            
            const tx = await contract.submitScore(finalScore, gameId, username);
            
            const receipt = await tx.wait();
            console.log("Transaksi submitScore berhasil:", receipt);

            // Cari event ScoreSubmitted untuk mendapatkan totalScore baru
            const scoreSubmittedEvent = receipt.events.find(e => e.event === 'ScoreSubmitted');
            let newTotalScore = finalScore;
            if (scoreSubmittedEvent) {
                newTotalScore = scoreSubmittedEvent.args.totalScore.toNumber();
            }

            // Setelah sukses di blockchain, simpan juga di Firestore (untuk kemudahan Leaderboard)
            await saveScoreToFirestore(newTotalScore, username);
            
            showModal("Skor Berhasil Dikirim!", `Skor akhir Anda (${finalScore}) berhasil dicatat. Total Skor Akumulasi Anda: ${newTotalScore}.`);

        } catch (error) {
            console.error("Transaksi submitScore Gagal:", error);
            
            let errorMessage = "Gagal mengirim skor. Coba lagi.";
            if (error.code === 4001) {
                errorMessage = "Anda membatalkan transaksi di dompet.";
            } else if (error.data && error.data.message) {
                 errorMessage = `Kontrak Tolak: ${error.data.message}. Mungkin skor Anda tidak melebihi skor terakhir atau sudah mencapai batas maksimum.`;
            }
            showModal("Pengiriman Skor Gagal", `Pesan Kesalahan: ${errorMessage}`);
        }
    }


    // ====================================================================
    // 4. FUNGSI FIREBASE (Leaderboard)
    // ====================================================================

    /** Fungsi untuk inisialisasi Firebase dari luar (dipanggil setelah auth siap) */
    window.initApp = (firestoreInstance, currentUserId) => {
        db = firestoreInstance;
        firebaseUserId = currentUserId;
        appId = window.firebaseData.getAppId();
        document.getElementById('user-firebase-id').textContent = firebaseUserId;
        loadLeaderboard();
        loadUserScore();
    };

    /** Memuat 10 Peringkat Teratas */
    function loadLeaderboard() {
        if (!db || !appId) {
            console.error("Firestore belum siap untuk memuat leaderboard.");
            return;
        }
        
        // Path koleksi publik untuk leaderboard global: /artifacts/{appId}/public/data/leaderboard
        const q = query(
            collection(db, "artifacts", appId, "public", "data", LEADERBOARD_COLLECTION),
            orderBy("totalScore", "desc"),
            limit(10)
        );

        onSnapshot(q, (snapshot) => {
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            
            if (snapshot.empty) {
                leaderboardList.innerHTML = '<div class="text-center text-gray-300 p-4">Belum ada skor yang dicatat.</div>';
                return;
            }

            snapshot.forEach((doc, index) => {
                const data = doc.data();
                const scoreItem = document.createElement('div');
                scoreItem.className = 'leaderboard-item';
                scoreItem.innerHTML = `
                    <span class="font-bold text-xl text-[#facc15]">${index + 1}.</span>
                    <span class="flex-grow mx-4 text-left">${data.username || 'Pemain Anon'} <span class="text-xs text-gray-400">(${data.userId.substring(0, 4)}...)</span></span>
                    <span class="font-bold text-lg text-white">${data.totalScore.toLocaleString()}</span>
                `;
                if (data.userId === firebaseUserId) {
                     scoreItem.style.backgroundColor = '#cc0000'; // Highlight skor pengguna
                }
                leaderboardList.appendChild(scoreItem);
            });
        }, (error) => {
             console.error("Gagal memuat leaderboard dari Firestore:", error);
             document.getElementById('leaderboard-list').innerHTML = '<div class="text-center text-red-400 p-4">Gagal memuat Leaderboard.</div>';
        });
    }

    /** Memuat skor akumulasi pengguna saat ini */
    async function loadUserScore() {
         if (!db || !appId || !firebaseUserId) return;
         
         const docRef = doc(db, "artifacts", appId, "public", "data", LEADERBOARD_COLLECTION, firebaseUserId);
         
         // Ambil skor sekali saat memuat
         const docSnap = await getDoc(docRef);
         if (docSnap.exists()) {
             const data = docSnap.data();
             const totalScoreDisplay = document.getElementById('user-total-score');
             if (totalScoreDisplay) {
                 totalScoreDisplay.textContent = data.totalScore.toLocaleString();
             }
         }
    }

    /** Menyimpan skor akumulasi total ke Firestore (dipanggil SETELAH sukses di blockchain) */
    async function saveScoreToFirestore(newTotalScore, username) {
        if (!db || !appId || !firebaseUserId) {
            console.error("Firestore belum siap untuk menyimpan skor.");
            return;
        }

        try {
            // Path dokumen publik: /artifacts/{appId}/public/data/leaderboard/{userId}
            const docRef = doc(db, "artifacts", appId, "public", "data", LEADERBOARD_COLLECTION, firebaseUserId);

            await setDoc(docRef, {
                userId: firebaseUserId,
                username: username,
                totalScore: newTotalScore,
                lastUpdated: new Date().toISOString()
            }, { merge: true }); // Gunakan merge untuk menjaga field lain

            console.log("Skor akumulasi disimpan ke Firestore:", newTotalScore);

        } catch (error) {
            console.error("Gagal menyimpan skor ke Firestore:", error);
        }
    }

    // ====================================================================
    // 5. LOGIKA GAME (PAC-MAN)
    // ====================================================================

    const canvas = document.getElementById('pacman-canvas');
    const ctx = canvas.getContext('2d');
    const TILE_SIZE = 20;
    const GAME_MAP = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
        [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
        [1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
        [1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
        [0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
        [1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
        [1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
        [1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];
    const MAP_WIDTH = GAME_MAP[0].length;
    const MAP_HEIGHT = GAME_MAP.length;
    canvas.width = MAP_WIDTH * TILE_SIZE;
    canvas.height = MAP_HEIGHT * TILE_SIZE;

    // Game state
    let pacman = { x: 1, y: 1, dir: 'right', nextDir: 'right', radius: TILE_SIZE / 2.5 };
    let ghosts = [
        { x: 9, y: 9, color: 'blue', dir: 'up', speed: 1 },
        { x: 10, y: 9, color: 'red', dir: 'down', speed: 1 },
    ];
    let score = 0;
    let gameRunning = false;
    let mapData = [];
    let animationFrameId = null;

    function resetMapData() {
        mapData = GAME_MAP.map(row => [...row]);
        score = 0;
        pacman = { x: 1, y: 1, dir: 'right', nextDir: 'right', radius: TILE_SIZE / 2.5 };
        ghosts = [
            { x: 9, y: 9, color: '#cc0000', dir: 'up', speed: 1 }, // Grinch Red
            { x: 10, y: 9, color: '#16a34a', dir: 'down', speed: 1 }, // Santa Green
        ];
    }

    function resetGame() {
        resetMapData();
        document.getElementById('current-score-display').textContent = score;
        document.getElementById('game-message').style.display = 'none';
        gameRunning = true;
    }

    function drawMap() {
        for (let y = 0; y < MAP_HEIGHT; y++) {
            for (let x = 0; x < MAP_WIDTH; x++) {
                const type = mapData[y][x];
                ctx.fillStyle = (x + y) % 2 === 0 ? '#cc0000' : '#ffffff'; // Striped Christmas Walls
                
                if (type === 1) { // Wall
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    ctx.strokeStyle = '#800000';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                } else {
                    ctx.fillStyle = '#1a2c42'; // Dark Blue path
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);

                    if (type === 2) { // Dot (Pellet)
                        ctx.fillStyle = '#facc15'; // Gold
                        ctx.beginPath();
                        ctx.arc(x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + TILE_SIZE / 2, TILE_SIZE / 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
        }
    }

    function drawPacman() {
        const x = pacman.x * TILE_SIZE + TILE_SIZE / 2;
        const y = pacman.y * TILE_SIZE + TILE_SIZE / 2;
        ctx.fillStyle = '#facc15'; // Yellow
        ctx.beginPath();
        
        // Mulut Pacman (Animasi sederhana)
        const mouthOpen = Math.abs(Math.sin(Date.now() / 100));
        const angleOffset = { 'right': 0, 'left': Math.PI, 'up': -Math.PI / 2, 'down': Math.PI / 2 }[pacman.dir];
        const startAngle = angleOffset + mouthOpen * 0.4;
        const endAngle = angleOffset - mouthOpen * 0.4 + 2 * Math.PI;

        ctx.arc(x, y, pacman.radius, startAngle, endAngle, false);
        ctx.lineTo(x, y);
        ctx.closePath();
        ctx.fill();
    }

    function drawGhosts() {
        ghosts.forEach(ghost => {
            const x = ghost.x * TILE_SIZE + TILE_SIZE / 2;
            const y = ghost.y * TILE_SIZE + TILE_SIZE / 2;
            
            ctx.fillStyle = ghost.color;
            ctx.beginPath();
            // Body
            ctx.arc(x, y, TILE_SIZE / 2, Math.PI, 0, false);
            ctx.rect(x - TILE_SIZE / 2, y, TILE_SIZE, TILE_SIZE / 2);
            // Skirt (Simple wobble)
            const wobble = Math.sin(Date.now() / 200) * 2;
            ctx.moveTo(x - TILE_SIZE / 2, y + TILE_SIZE / 2);
            ctx.lineTo(x - TILE_SIZE / 2 + TILE_SIZE / 4 + wobble, y + TILE_SIZE / 2 - 3);
            ctx.lineTo(x, y + TILE_SIZE / 2);
            ctx.lineTo(x + TILE_SIZE / 2 - TILE_SIZE / 4 - wobble, y + TILE_SIZE / 2 - 3);
            ctx.lineTo(x + TILE_SIZE / 2, y + TILE_SIZE / 2);
            
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(x - TILE_SIZE / 4, y - TILE_SIZE / 4, TILE_SIZE / 8, 0, Math.PI * 2);
            ctx.arc(x + TILE_SIZE / 4, y - TILE_SIZE / 4, TILE_SIZE / 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Pupils
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(x - TILE_SIZE / 4 + 1, y - TILE_SIZE / 4, TILE_SIZE / 16, 0, Math.PI * 2);
            ctx.arc(x + TILE_SIZE / 4 + 1, y - TILE_SIZE / 4, TILE_SIZE / 16, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function movePacman() {
        const nextX = pacman.x + (pacman.nextDir === 'right' ? 1 : pacman.nextDir === 'left' ? -1 : 0);
        const nextY = pacman.y + (pacman.nextDir === 'down' ? 1 : pacman.nextDir === 'up' ? -1 : 0);

        // Cek arah selanjutnya
        if (mapData[nextY] && mapData[nextY][nextX] !== 1) {
            pacman.dir = pacman.nextDir;
            pacman.x = nextX;
            pacman.y = nextY;
        } else {
            // Cek arah saat ini
            const currentX = pacman.x + (pacman.dir === 'right' ? 1 : pacman.dir === 'left' ? -1 : 0);
            const currentY = pacman.y + (pacman.dir === 'down' ? 1 : pacman.dir === 'up' ? -1 : 0);

            if (mapData[currentY] && mapData[currentY][currentX] !== 1) {
                pacman.x = currentX;
                pacman.y = currentY;
            }
        }
        
        // Teleport
        if (pacman.x < 0) pacman.x = MAP_WIDTH - 1;
        if (pacman.x >= MAP_WIDTH) pacman.x = 0;
    }

    function moveGhosts() {
        ghosts.forEach(ghost => {
            const possibleMoves = [];
            const moves = [
                { dx: 1, dy: 0, dir: 'right' },
                { dx: -1, dy: 0, dir: 'left' },
                { dx: 0, dy: 1, dir: 'down' },
                { dx: 0, dy: -1, dir: 'up' }
            ];

            moves.forEach(move => {
                const nextX = ghost.x + move.dx;
                const nextY = ghost.y + move.dy;
                
                // Pastikan gerakan tidak menabrak tembok (1) dan bukan arah balik 180 derajat
                if (mapData[nextY] && mapData[nextY][nextX] !== 1) {
                    // Tambahkan semua arah yang valid
                    possibleMoves.push(move);
                }
            });

            if (possibleMoves.length > 0) {
                // Sederhana: pilih gerakan acak dari yang valid
                const move = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                ghost.x += move.dx;
                ghost.y += move.dy;
                ghost.dir = move.dir;
            }
        });
    }
    
    function checkCollision() {
        // Cek dot
        if (mapData[pacman.y][pacman.x] === 2) {
            mapData[pacman.y][pacman.x] = 0; // Hilangkan dot
            score += 10;
            document.getElementById('current-score-display').textContent = score;

            // Cek apakah semua dot sudah dikumpulkan
            let dotsRemaining = mapData.flat().filter(cell => cell === 2).length;
            if (dotsRemaining === 0) {
                endGame("SELAMAT! LEVEL SELESAI!");
            }
        }

        // Cek hantu
        ghosts.forEach(ghost => {
            if (pacman.x === ghost.x && pacman.y === ghost.y) {
                endGame("Misi Gagal! Anda tertangkap!");
            }
        });
    }

    function endGame(message) {
        if (!gameRunning) return;
        gameRunning = false;
        cancelAnimationFrame(animationFrameId);
        
        document.getElementById('game-message').textContent = message;
        document.getElementById('game-message').style.display = 'block';
        
        // Panggil pengiriman skor (hanya jika berhasil diselesaikan atau ada skor)
        if (score > 0) {
            submitScoreTx(score);
        } else if (message.includes("SELAMAT")) {
            // Jika menang tapi skor 0 (kasus langka), kirim 1 sebagai tanda kemenangan
            submitScoreTx(1);
        }

        // Setelah game selesai, tampilkan lagi UI utama
        setTimeout(() => {
            document.getElementById('game-container').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            resetGame(); // Reset untuk sesi berikutnya
        }, 5000);
    }

    let lastTime = 0;
    const FRAME_RATE = 1000 / 60; // 60 FPS
    let gameUpdateTimer = 0;
    const GAME_UPDATE_INTERVAL = 150; // Update game state setiap 150ms

    function gameLoop(timestamp) {
        if (!gameRunning) return;

        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMap();
        drawPacman();
        drawGhosts();
        
        gameUpdateTimer += deltaTime;
        if (gameUpdateTimer > GAME_UPDATE_INTERVAL) {
            movePacman();
            moveGhosts(); // Hantu bergerak lebih lambat
            checkCollision();
            gameUpdateTimer = 0;
        }

        animationFrameId = requestAnimationFrame(gameLoop);
    }
    
    function startGameLoop() {
        gameRunning = true;
        lastTime = performance.now();
        gameLoop(lastTime);
    }

    // ====================================================================
    // 6. EVENT LISTENERS
    // ====================================================================

    // Tombol Koneksi
    document.getElementById('connect-wallet-btn').addEventListener('click', initWeb3);

    // Tombol Mulai Game
    document.getElementById('start-game-btn').addEventListener('click', startGameTx);

    // Kontrol Keyboard
    document.addEventListener('keydown', (e) => {
        if (!gameRunning) return;
        const key = e.key.toLowerCase();
        if (['w', 'a', 's', 'd', 'arrowup', 'arrowleft', 'arrowdown', 'arrowright'].includes(key)) {
            e.preventDefault(); // Mencegah scrolling
            pacman.nextDir = 
                key === 'w' || key === 'arrowup' ? 'up' :
                key === 's' || key === 'arrowdown' ? 'down' :
                key === 'a' || key === 'arrowleft' ? 'left' :
                'right';
        }
    });

    // Kontrol Tombol Mobile
    document.querySelectorAll('.control-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
             if (!gameRunning) return;
             const key = e.currentTarget.getAttribute('data-key');
             pacman.nextDir = 
                key === 'w' ? 'up' :
                key === 's' ? 'down' :
                key === 'a' ? 'left' :
                'right';
        });
    });
    
    // Inisialisasi awal saat halaman dimuat
    window.onload = function() {
        initWeb3();
        resetGame(); // Reset game map, tapi tidak memulai loop
    };

</script>

</body>
</html>

